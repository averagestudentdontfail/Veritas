%%% Configuration/12-Floats.sty %%%
%%% Float Placement Configuration for Veritas Template
%%%
%%% FIRST PRINCIPLES BASIS:
%%% This module implements float placement derived from:
%%%
%%% 1. Mittelbach, F. et al. (2023). The LaTeX Companion. 3rd ed.
%%%    - Float placement algorithm parameters (ยง8.9)
%%%    - Best practices for figure/table positioning
%%%
%%% 2. Knuth, D.E. (1986). The TeXbook.
%%%    - Glue and penalty system for page breaking
%%%    - Float insertion algorithms
%%%
%%% 3. Standard.md LOC-2 Rule 5
%%%    - All floats shall have explicit placement specifiers
%%%    - Do not rely on implicit [tbp] default
%%%
%%% COMPLIANCE: Standard.md
%%% - LOC-1 Rule 1: LaTeX2e conformant
%%% - LOC-2 Rule 5: Explicit float placement (default [htbp])
%%% - LOC-4 Rule 14: Semantic environments

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{12-Floats}[2025/12/12 v1.0.0 Veritas Float Configuration]

%%% Required Packages %%%
\RequirePackage{lscape}
\RequirePackage{fancyhdr}
\RequirePackage{geometry}
\RequirePackage{calc}
\RequirePackage{afterpage}
\RequirePackage{etoolbox}

%%% Float Counter Limits %%%
% Maximum floats per page (LaTeX Companion ยง7.1)
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\setcounter{dbltopnumber}{3}

%%% Float Fractions %%%
% Percentage of page available for floats
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.7}
\renewcommand{\textfraction}{0.15}
\renewcommand{\floatpagefraction}{0.7}
\renewcommand{\dbltopfraction}{0.85}

%%% Float Spacing %%%
\setlength{\floatsep}{12pt plus 4pt minus 4pt}
\setlength{\textfloatsep}{15pt plus 5pt minus 5pt}
\setlength{\intextsep}{12pt plus 4pt minus 4pt}
\setlength{\dblfloatsep}{12pt plus 4pt minus 4pt}
\setlength{\dbltextfloatsep}{15pt plus 5pt minus 5pt}

%%% Caption Spacing %%%
\setlength{\abovecaptionskip}{8pt}
\setlength{\belowcaptionskip}{6pt}

%%% Automatic Float Spacing %%%
\newcommand{\autofloatspacing}{%
    \@ifundefined{@captype}{}{%
        \vspace{3pt plus 2pt minus 1pt}%
    }%
}

%%% Enhanced Figure Environment %%%
% LOC-2 Rule 5: Default to [htbp] explicit placement
\let\oldfigure\figure
\let\endoldfigure\endfigure
\renewenvironment{figure}[1][htbp]{%
    \oldfigure[#1]%
    \centering%
}{%
    \autofloatspacing%
    \endoldfigure%
}

%%% Enhanced Table Environment %%%
% LOC-2 Rule 5: Default to [htbp] explicit placement
\let\oldtable\table
\let\endoldtable\endtable
\renewenvironment{table}[1][htbp]{%
    \oldtable[#1]%
    \centering%
}{%
    \autofloatspacing%
    \endoldtable%
}

%%% Landscape Figure Environment %%%
\newenvironment{landscapefigure}[1][htbp]{%
    \clearpage%
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\leftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \thispagestyle{landscapefancy}%
    \begin{figure}[#1]%
    \centering%
}{%
    \end{figure}%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    \cleardoublepage%
}

%%% Landscape Table Environment %%%
\newenvironment{landscapetable}[1][htbp]{%
    \clearpage%
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\leftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \thispagestyle{landscapefancy}%
    \begin{table}[#1]%
    \centering%
}{%
    \end{table}%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    \cleardoublepage%
}

%%% Landscape Longtable Environment %%%
\makeatletter
\newenvironment{landscapelongtable}{%
    \clearpage%
    \let\saved@leftmark\leftmark
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\saved@leftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \setlength\LTleft{\fill}%
    \setlength\LTright{\fill}%
    \setlength\LTpre{0pt}%
    \setlength\LTpost{0pt}%
}{%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    \markboth{\saved@leftmark}{}%
}
\makeatother

%%% Post-Landscape Cleanup %%%
\AtEndEnvironment{landscapelongtable}{%
    \aftergroup\landscapecleanup%
}

\newcommand{\landscapecleanup}{%
    \clearpage%
    \newgeometry{
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \pagestyle{mainmatter}%
    \clearpage%
}

%%% Smart Float Placement %%%
\newcommand{\smartfloat}[2][htbp]{%
    \begingroup%
    \setlength{\intextsep}{10pt plus 3pt minus 3pt}%
    \begin{figure}[#1]%
    \centering%
    #2%
    \end{figure}%
    \endgroup%
}

%%% Float Barrier %%%
\newcommand{\floatbarrier}{%
    \par\vspace{0pt plus 10pt minus 5pt}%
    \FloatBarrier%
    \par\vspace{0pt plus 10pt minus 5pt}%
}

%%% Caption Auto-Spacing %%%
\DeclareCaptionFormat{autospacing}{%
    \vspace{2pt}#1#2#3\vspace{4pt}%
}
\captionsetup{format=autospacing}

%%% Auto Width Handling %%%
\newcommand{\autofigurewidth}[2][0.8]{%
    \ifdim\width>#1\textwidth%
        \resizebox{#1\textwidth}{!}{#2}%
    \else%
        #2%
    \fi%
}

%%% Side-by-Side Figures %%%
\newenvironment{sidebysideFigures}[1][0.45]{%
    \begin{figure}[htbp]%
    \centering%
    \newcommand{\subfigwidth}{#1\textwidth}%
}{%
    \end{figure}%
}

\newcommand{\autosubfigure}[3][0.45]{%
    \begin{subfigure}[b]{#1\textwidth}%
        \centering%
        \autofigurewidth[0.95]{#2}%
        \caption{#3}%
    \end{subfigure}%
}

%%% Float Page Spacing %%%
\makeatletter
\setlength{\@fptop}{0pt plus 1fil}
\setlength{\@fpsep}{8pt plus 2fil}
\setlength{\@fpbot}{0pt plus 1fil}
\makeatother

%%% Float Barriers at Sections %%%
\RequirePackage{placeins}

\makeatletter
\AtBeginDocument{%
  \let\oldsection\section
  \renewcommand{\section}{%
    \FloatBarrier
    \oldsection
  }%
  \let\oldsubsection\subsection
  \renewcommand{\subsection}{%
    \FloatBarrier
    \oldsubsection
  }%
}
\makeatother