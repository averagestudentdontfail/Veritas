%%% Configurations/12-Floats.sty %%%

% Required packages
\RequirePackage{lscape}
\RequirePackage{fancyhdr}
\RequirePackage{geometry}
\RequirePackage{calc}
\RequirePackage{afterpage}

% Float placement parameters
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\setcounter{dbltopnumber}{3}

% Float fractions
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.7}
\renewcommand{\textfraction}{0.15}
\renewcommand{\floatpagefraction}{0.7}
\renewcommand{\dbltopfraction}{0.85}

% Float spacing parameters
\setlength{\floatsep}{12pt plus 4pt minus 4pt}
\setlength{\textfloatsep}{15pt plus 5pt minus 5pt}
\setlength{\intextsep}{12pt plus 4pt minus 4pt}
\setlength{\dblfloatsep}{12pt plus 4pt minus 4pt}
\setlength{\dbltextfloatsep}{15pt plus 5pt minus 5pt}

% Caption spacing
\setlength{\abovecaptionskip}{8pt}
\setlength{\belowcaptionskip}{6pt}

% Automatic float spacing
\newcommand{\autofloatspacing}{%
    \@ifundefined{@captype}{}{%
        \vspace{3pt plus 2pt minus 1pt}%
    }%
}

% Enhanced figure environment
\let\oldfigure\figure
\let\endoldfigure\endfigure
\renewenvironment{figure}[1][htbp]{%
    \oldfigure[#1]%
    \centering%
}{%
    \autofloatspacing%
    \endoldfigure%
}

% Enhanced table environment
\let\oldtable\table
\let\endoldtable\endtable
\renewenvironment{table}[1][htbp]{%
    \oldtable[#1]%
    \centering%
}{%
    \autofloatspacing%
    \endoldtable%
}

% Landscape figure environment
\newenvironment{landscapefigure}[1][htbp]{%
    \clearpage%
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\leftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \thispagestyle{landscapefancy}%
    \begin{figure}[#1]%
    \centering%
}{%
    \end{figure}%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    \cleardoublepage%
}

% Landscape table environment
\newenvironment{landscapetable}[1][htbp]{%
    \clearpage%
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\leftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \thispagestyle{landscapefancy}%
    \begin{table}[#1]%
    \centering%
}{%
    \end{table}%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    \cleardoublepage%
}

% FIXED: Landscape longtable with proper chapter mark restoration
\newenvironment{landscapelongtable}{%
    % Save current chapter information
    \edef\savedleftmark{\leftmark}%
    \edef\savedrightmark{\rightmark}%
    \clearpage%
    \newgeometry{
        paperwidth=297mm,
        paperheight=210mm,
        top=2.54cm,
        bottom=2.54cm,
        left=3.15cm,
        right=3.15cm,
        headsep=0.75cm,
        footskip=1.6cm
    }%
    \setlength{\textwidth}{\dimexpr 297mm - 6.3cm\relax}%
    \setlength{\linewidth}{\textwidth}%
    \setlength{\columnwidth}{\textwidth}%
    \setlength{\hsize}{\textwidth}%
    \fancypagestyle{landscapefancy}{%
        \fancyhf{}%
        \setlength{\headwidth}{\textwidth}%
        \fancyheadoffset{0pt}%
        \fancyhead[L]{\thepage\vspace{3pt}}%
        \fancyhead[R]{\savedleftmark\vspace{3pt}}%
        \renewcommand{\headrulewidth}{0.3pt}%
    }%
    \pagestyle{landscapefancy}%
    \setlength\LTleft{\fill}%
    \setlength\LTright{\fill}%
    \setlength\LTpre{0pt}%
    \setlength\LTpost{0pt}%
}{%
    \clearpage%
    \restoregeometry%
    \pagestyle{mainmatter}%
    % Force chapter mark restoration
    \markboth{\savedleftmark}{\savedrightmark}%
    \cleardoublepage%
}

% Smart float placement
\newcommand{\smartfloat}[2][htbp]{%
    \begingroup%
    \setlength{\intextsep}{10pt plus 3pt minus 3pt}%
    \begin{figure}[#1]%
    \centering%
    #2%
    \end{figure}%
    \endgroup%
}

% Float barrier
\newcommand{\floatbarrier}{%
    \par\vspace{0pt plus 10pt minus 5pt}%
    \FloatBarrier%
    \par\vspace{0pt plus 10pt minus 5pt}%
}

% Auto spacing for captions
\DeclareCaptionFormat{autospacing}{%
    \vspace{2pt}#1#2#3\vspace{4pt}%
}

\captionsetup{format=autospacing}

% Auto width handling
\newcommand{\autofigurewidth}[2][0.8]{%
    \ifdim\width>#1\textwidth%
        \resizebox{#1\textwidth}{!}{#2}%
    \else%
        #2%
    \fi%
}

% Side by side figures
\newenvironment{sidebysideFigures}[1][0.45]{%
    \begin{figure}[htbp]%
    \centering%
    \newcommand{\subfigwidth}{#1\textwidth}%
}{%
    \end{figure}%
}

\newcommand{\autosubfigure}[3][0.45]{%
    \begin{subfigure}[b]{#1\textwidth}%
        \centering%
        \autofigurewidth[0.95]{#2}%
        \caption{#3}%
    \end{subfigure}%
}

% Better float page handling
\makeatletter
\setlength{\@fptop}{0pt plus 1fil}
\setlength{\@fpsep}{8pt plus 2fil}
\setlength{\@fpbot}{0pt plus 1fil}
\makeatother

% Float barriers at sections
\RequirePackage{placeins}

\makeatletter
\AtBeginDocument{%
  \let\oldsection\section
  \renewcommand{\section}{%
    \FloatBarrier
    \oldsection
  }%
  \let\oldsubsection\subsection
  \renewcommand{\subsection}{%
    \FloatBarrier
    \oldsubsection
  }%
}
\makeatother